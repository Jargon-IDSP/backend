generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum FollowStatus {
  FOLLOWING
  BLOCKED
}

enum QuizVisibility {
  PRIVATE        // Only owner
  FRIENDS        // All friends (mutual follows)
  PUBLIC         // Everyone
  SPECIFIC       // Specific users via CustomQuizShare table
}

enum QuizType {
  TERM_TO_TRANSLATION
  TRANSLATION_TO_DEFINITION
  MIXED_QUESTIONS
  BOSS_QUIZ
}

enum BadgeCategory {
  QUIZ_COMPLETION
  LEVEL_COMPLETION
  STREAK
  POINTS_MILESTONE
  SPECIAL
}

model Category {
  id        Int     @id @default(autoincrement())
  name      String
  userId    String?  // Null for default categories, set for custom categories
  isDefault Boolean @default(false)

  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents        Document[]
  customFlashcards CustomFlashcard[]
  customQuestions  CustomQuestion[]
  customQuizzes    CustomQuiz[]
  documents        Document[]

  @@unique([name, userId])  // Name must be unique per user, or unique for defaults (userId = null)
  @@index([userId])
  @@index([isDefault])
  @@index([userId, isDefault])
  @@map("categories")
}

model Industry {
  id   Int    @id @default(autoincrement())
  name String @unique

  flashcards    Flashcard[]
  users         User[]
  prebuiltQuizzes PrebuiltQuiz[]
  badges        Badge[]
  apprenticeshipProgress UserApprenticeshipProgress[]

  @@map("industries")
}

model Level {
  id   Int    @id @default(autoincrement())
  name String @unique

  flashcards             Flashcard[]
  quizAttempts           UserQuizAttempt[]
  prebuiltQuizzes        PrebuiltQuiz[]
  badges                 Badge[]
  apprenticeshipProgress UserApprenticeshipProgress[]

  @@map("levels")
}

model Flashcard {
  id                String     @id
  termEnglish       String     @db.Text
  termFrench        String     @db.Text
  termChinese       String     @db.Text
  termSpanish       String     @db.Text
  termTagalog       String     @db.Text
  termPunjabi       String     @db.Text
  termKorean        String     @db.Text
  definitionEnglish String     @db.Text
  definitionFrench  String     @db.Text
  definitionChinese String     @db.Text
  definitionSpanish String     @db.Text
  definitionTagalog String     @db.Text
  definitionPunjabi String     @db.Text
  definitionKorean  String     @db.Text
  industryId        Int?
  levelId           Int
  industry          Industry?  @relation(fields: [industryId], references: [id])
  level             Level      @relation(fields: [levelId], references: [id])
  questions         Question[] @relation("QuestionCorrectAnswer")

  @@index([levelId, industryId])
  @@index([industryId, levelId])
  @@index([levelId])
  @@index([termEnglish(length: 255)])
  @@map("flashcards")
}

model Question {
  id            String    @id
  correctTermId String
  promptEnglish String    @db.Text
  promptFrench  String    @db.Text
  promptChinese String    @db.Text
  promptSpanish String    @db.Text
  promptTagalog String    @db.Text
  promptPunjabi String    @db.Text
  promptKorean  String    @db.Text
  difficulty    Int
  tags          String    @db.Text
  points        Int       @default(5)
  correctAnswer Flashcard @relation("QuestionCorrectAnswer", fields: [correctTermId], references: [id])

  @@index([correctTermId], map: "questions_correctTermId_fkey")
  @@index([difficulty])
  @@index([points])
  @@map("questions")
}

model PrebuiltQuiz {
  id        String   @id @default(cuid())
  templateId String  @unique

  levelId    Int
  industryId Int?
  quizNumber Int

  name        String  @db.Text
  description String? @db.Text

  quizType      QuizType

  questionsPerQuiz    Int     @default(10)
  allowAIHelp         Boolean @default(true)
  allowTranslation    Boolean @default(true)
  allowBackNavigation Boolean @default(true)
  pointsPerQuestion   Int     @default(5)
  requiredToUnlock    Boolean @default(false)
  passingScore        Int?

  level    Level     @relation(fields: [levelId], references: [id])
  industry Industry? @relation(fields: [industryId], references: [id])

  attempts UserQuizAttempt[]

  @@unique([levelId, industryId, quizNumber])
  @@index([levelId])
  @@index([levelId, industryId])
  @@index([quizType])
  @@index([quizNumber])
  @@map("prebuilt_quizzes")
}

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique

  name        String @db.Text
  description String @db.Text

  iconUrl     String?
  category    BadgeCategory

  levelId      Int?
  industryId   Int?

  requiresQuizCount  Int?
  requiresPoints     Int?

  level    Level?     @relation(fields: [levelId], references: [id])
  industry Industry?  @relation(fields: [industryId], references: [id])

  userBadges UserBadge[]

  @@index([category])
  @@index([levelId])
  @@index([industryId])
  @@index([levelId, industryId])
  @@map("badges")
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
  @@map("user_badges")
}

model UserApprenticeshipProgress {
  id       String   @id @default(cuid())
  userId   String
  levelId  Int
  industryId Int?

  quizzesCompleted Int     @default(0)
  isLevelComplete  Boolean @default(false)

  unlockedAt   DateTime  @default(now())
  completedAt  DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  level    Level     @relation(fields: [levelId], references: [id])
  industry Industry? @relation(fields: [industryId], references: [id])

  @@unique([userId, levelId, industryId])
  @@index([userId])
  @@index([userId, levelId])
  @@index([levelId, industryId])
  @@index([isLevelComplete])
  @@map("user_apprenticeship_progress")
}

model Document {
  id            String               @id @default(cuid())
  filename      String
  fileKey       String
  fileUrl       String
  fileType      String
  fileSize      Int?
  extractedText String?              @db.Text
  ocrProcessed  Boolean              @default(false)
  userId        String
  categoryId    Int                  @default(6)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  flashcards    CustomFlashcard[]
  customQuizzes CustomQuiz[]
  translation   DocumentTranslation?
  category      Category             @relation(fields: [categoryId], references: [id])
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, categoryId])
  @@map("documents")
}

model DocumentTranslation {
  id          String   @id @default(cuid())
  documentId  String   @unique
  userId      String
  textEnglish String   @db.LongText
  textFrench  String   @db.LongText
  textChinese String   @db.LongText
  textSpanish String   @db.LongText
  textTagalog String   @db.LongText
  textPunjabi String   @db.LongText
  textKorean  String   @db.LongText
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@map("document_translations")
}

model CustomFlashcard {
  id                String           @id @default(cuid())
  documentId        String?
  userId            String
  categoryId        Int              @default(6)
  termEnglish       String           @db.Text
  termFrench        String           @db.Text
  termChinese       String           @db.Text
  termSpanish       String           @db.Text
  termTagalog       String           @db.Text
  termPunjabi       String           @db.Text
  termKorean        String           @db.Text
  definitionEnglish String           @db.Text
  definitionFrench  String           @db.Text
  definitionChinese String           @db.Text
  definitionSpanish String           @db.Text
  definitionTagalog String           @db.Text
  definitionPunjabi String           @db.Text
  definitionKorean  String           @db.Text
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  category          Category         @relation(fields: [categoryId], references: [id])
  document          Document?        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions         CustomQuestion[] @relation("CustomQuestionCorrectAnswer")
  userAnswers       UserQuizAnswer[] @relation("UserQuizAnswers")

  @@index([userId, createdAt])
  @@index([documentId, createdAt])
  @@index([categoryId])
  @@index([termEnglish(length: 255)])
  @@map("custom_flashcards")
}

model CustomQuestion {
  id            String           @id @default(cuid())
  userId        String
  customQuizId  String?
  correctTermId String
  categoryId    Int              @default(6)
  promptEnglish String           @db.Text
  promptFrench  String           @db.Text
  promptChinese String           @db.Text
  promptSpanish String           @db.Text
  promptTagalog String           @db.Text
  promptPunjabi String           @db.Text
  promptKorean  String           @db.Text
  pointsWorth   Int              @default(10)
  createdAt     DateTime         @default(now())
  category      Category         @relation(fields: [categoryId], references: [id])
  correctAnswer CustomFlashcard  @relation("CustomQuestionCorrectAnswer", fields: [correctTermId], references: [id], onDelete: Cascade)
  customQuiz    CustomQuiz?      @relation(fields: [customQuizId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAnswers   UserQuizAnswer[]

  @@index([userId, createdAt])
  @@index([customQuizId, createdAt])
  @@index([categoryId])
  @@index([correctTermId])
  @@map("custom_questions")
}

model CustomQuiz {
  id String @id @default(cuid())

  userId     String
  documentId String?
  name       String
  categoryId Int      @default(6) // Default to General category

  visibility        QuizVisibility @default(PRIVATE)
  pointsPerQuestion Int            @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   Category          @relation(fields: [categoryId], references: [id])
  document   Document?         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  questions  CustomQuestion[]
  sharedWith CustomQuizShare[]
  attempts   UserQuizAttempt[]

  @@index([userId])
  @@index([categoryId])
  @@index([documentId])
  @@index([visibility])
  @@index([userId, createdAt])
  @@index([userId, categoryId])
  @@index([userId, visibility])
  @@map("custom_quizzes")
}

model CustomQuizShare {
  id               String     @id @default(cuid())
  customQuizId     String
  sharedWithUserId String
  sharedAt         DateTime   @default(now())
  customQuiz       CustomQuiz @relation(fields: [customQuizId], references: [id], onDelete: Cascade)
  sharedWith       User       @relation("SharedCustomQuizzes", fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@unique([customQuizId, sharedWithUserId])
  @@index([customQuizId])
  @@index([sharedWithUserId])
  @@map("custom_quiz_shares")
}

model UserQuizAttempt {
  id String @id @default(cuid())

  userId         String
  customQuizId   String?
  prebuiltQuizId String?
  levelId        Int?

  questionIds String? @db.Text

  questionsAnswered   Int @default(0)
  questionsCorrect    Int @default(0)
  totalQuestions      Int

  percentComplete     Int @default(0)
  percentCorrect      Int @default(0)

  pointsEarned        Int @default(0)
  maxPossiblePoints   Int

  completed   Boolean  @default(false)
  startedAt   DateTime @default(now())
  completedAt DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  customQuiz   CustomQuiz?   @relation(fields: [customQuizId], references: [id], onDelete: Cascade)
  prebuiltQuiz PrebuiltQuiz? @relation(fields: [prebuiltQuizId], references: [id], onDelete: Cascade)
  level        Level?        @relation(fields: [levelId], references: [id], onDelete: SetNull)

  customAnswers    UserQuizAnswer[]
  prebuiltAnswers  PrebuiltQuizAnswer[]

  @@index([userId])
  @@index([customQuizId])
  @@index([prebuiltQuizId])
  @@index([levelId])
  @@index([completed])
  @@index([userId, completed])
  @@index([userId, customQuizId])
  @@index([userId, prebuiltQuizId])
  @@index([userId, levelId])
  @@index([userId, completedAt])
  @@map("user_quiz_attempts")
}

model UserQuizAnswer {
  id String @id @default(cuid())

  attemptId  String
  questionId String
  answerId   String

  isCorrect    Boolean
  pointsEarned Int @default(0)

  answeredAt DateTime @default(now())

  attempt  UserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question CustomQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer   CustomFlashcard @relation("UserQuizAnswers", fields: [answerId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([answerId], map: "user_quiz_answers_answerId_fkey")
  @@map("user_quiz_answers")
}

model PrebuiltQuizAnswer {
  id String @id @default(cuid())

  attemptId  String
  questionId String
  answerId   String

  isCorrect    Boolean
  pointsEarned Int @default(0)

  answeredAt DateTime @default(now())

  attempt UserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([answerId])
  @@map("prebuilt_quiz_answers")
}

model UserWeeklyStats {
  id            String   @id @default(cuid())
  userId        String
  weekStartDate DateTime
  weeklyScore   Int      @default(0)
  daysActive    String   @default("")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
  @@index([weeklyScore])
  @@map("user_weekly_stats")
}

model User {
  id        String   @id
  email     String
  firstName String?
  lastName  String?
  username  String?
  language  String   @default("english")
  industryId Int?
  onboardingCompleted Boolean @default(false)
  introductionViewed Boolean @default(false)
  score     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  avatar               UserAvatar?
  documents            Document[]
  customFlashcards     CustomFlashcard[]
  customQuestions      CustomQuestion[]
  customQuizzes        CustomQuiz[]
  quizAttempts         UserQuizAttempt[]
  documentTranslations DocumentTranslation[]
  documents            Document[]
  friendshipsReceived  Friendship[]          @relation("FriendshipAddressee")
  friendshipsInitiated Friendship[]          @relation("FriendshipRequester")
  avatar               UserAvatar?
  quizAttempts         UserQuizAttempt[]
  weeklyStats          UserWeeklyStats[]
  badges               UserBadge[]
  apprenticeshipProgress UserApprenticeshipProgress[]
  customCategories     Category[]

  industry Industry? @relation(fields: [industryId], references: [id])

  following Follow[] @relation("UserFollowing")
  followers Follow[] @relation("UserFollowers")

  sharedQuizzes CustomQuizShare[] @relation("SharedCustomQuizzes") 
  
  @@index([email])
  @@index([score])
  @@index([industryId])
  @@index([language])
  @@map("users")
}

model UserAvatar {
  id             String   @id @default(cuid())
  userId         String   @unique
  character      String   @default("rocky")
  outfit         String   @default("default")
  hatType        String?
  accessory1     String?
  accessory2     String?
  accessory3     String?
  primaryColor   String   @default("#FFB6C1")
  secondaryColor String   @default("#FF69B4")
  accentColor    String   @default("#FFC0CB")
  unlockedItems  String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_avatars")
}

model Follow {
  id String @id @default(cuid())

  followerId  String
  followingId String

  status FollowStatus @default(FOLLOWING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([status])
  @@index([followerId, status])
  @@index([followingId, status])
  @@map("follows")
}

